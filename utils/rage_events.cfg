#textdomain wesnoth-Rage

#define RAGERESISTANCEBONUS_PART DIR
    [resistance]
        id=resbonus{DIR}
        add=5
        max_value=70
        # applies to any type if we leave it out
        #apply_to=blade,pierce,impact,fire,cold,arcane
        affect_self=yes
        [filter_adjacent]
            [filter_side]
                [enemy_of]
                    side=1
                [/enemy_of]
            [/filter_side]
#            is_enemy=yes
            adjacent={DIR}
            count=1-6
        [/filter_adjacent]
    [/resistance]
#enddef

#define ABILITY_ENDURANCE_VII
#    [dummy]
#        id=enduranceVII
#        name= _ "endurance VII"
#        description= _ "Gain +5% to all resistance for every adjacent enemy"
#    [/dummy]
    {RAGERESISTANCEBONUS_PART n}
    {RAGERESISTANCEBONUS_PART ne}
    {RAGERESISTANCEBONUS_PART nw}
    {RAGERESISTANCEBONUS_PART s}
    {RAGERESISTANCEBONUS_PART se}
    {RAGERESISTANCEBONUS_PART sw}
#enddef

#define ABILITY_STEADFAST_BASED_ON_HP
    # Canned definition of the Steadfast ability to be included in an [abilities]
    # clause.
    [resistance]
        id=steadfast
        multiply=2
        max_value=50
        # applies to any type if we leave it out
        #apply_to=blade,pierce,impact,fire,cold,arcane
        [filter_base_value]
            greater_than=0
            less_than=50
        [/filter_base_value]
        name= _ "steadfast"
        female_name= _ "female^steadfast"
        description= _ "This unitâ€™s resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
        special_note={INTERNAL:SPECIAL_NOTES_STEADFAST}
        affect_self=yes
        active_on=defense
    [/resistance]
#enddef

#define RAGE_APPLY_EFFECT_TO_ALL_DRAKES CODE
        [store_unit]
            [filter]
                side=1
#                race=drake
            [/filter]
            variable=rage_side1
            kill=no
        [/store_unit]
        [foreach]
            array=rage_side1
            index_var=i
            [do]
                {CODE}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE rage_side1}
#enddef

#define RAGE_UPGRADE_OPTION TYPE NUM DESCR IMAGE EFFECT
    [option]
        image={IMAGE}
        description={DESCR}
        [show_if]
            {VARIABLE_CONDITIONAL rage_upgrade_preview not_equals yes}
            [and]
                [not]
                    {VARIABLE_CONDITIONAL upgrades_{TYPE} greater_than_equal_to {NUM}}
                [/not]
            [/and]
            [and]
                [not]
                    {VARIABLE_CONDITIONAL upgrades_{TYPE} less_than "$({NUM} - 1)"}
                [/not]
            [/and]
        [/show_if]
        [command]
        {EFFECT}
        {VARIABLE rage_upgrade_chosen yes}
        {VARIABLE_OP upgrades_{TYPE} add 1}
        [/command]
    [/option]
    [option]
        image="{IMAGE}~GS()"
        description={DESCR}
        [show_if]
            {VARIABLE_CONDITIONAL rage_upgrade_preview equals yes}
            [and]
                [not]
                    {VARIABLE_CONDITIONAL upgrades_{TYPE} greater_than_equal_to {NUM}}
                [/not]
            [/and]
        [/show_if]
        [command]
        [/command]
    [/option]
    [option]
        image="{IMAGE}"
        description=_"(Already Unlocked) "+{DESCR}
        [show_if]
            {VARIABLE_CONDITIONAL rage_upgrade_preview equals yes}
            [and]
                {VARIABLE_CONDITIONAL upgrades_{TYPE} greater_than_equal_to {NUM}}
            [/and]
        [/show_if]
        [command]
        [/command]
    [/option]
#enddef

#define RAGE_ENDURANCE_3HP
    {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
        [unstore_unit]
            variable=this_item
            find_vacant=no
            text=_"+3 max hp"
            red,green,blue=255,155,0
        [/unstore_unit]
        [object]
            silent=yes
            duration=forever
            [filter]
                id=$this_item.id
            [/filter]
            [effect]
                apply_to=hitpoints
                increase=3
                increase_total=3
            [/effect]
        [/object]
    )}
#enddef

#define RAGE_UPGRADE_LISt
    {RAGE_UPGRADE_OPTION strength 1 _"Strength I: +1 damage to all attacks" "attacks/warblade-red.png" (
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"+1 damage"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever#turn end
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=1
                [/effect]
            [/object]
        )}
    )}
    {RAGE_UPGRADE_OPTION strength 2 _"Strength II: +1 damage to all attacks" "attacks/warblade-red.png" (
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"+1 damage"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever#turn end
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=1
                [/effect]
            [/object]
        )}
    )}
    {RAGE_UPGRADE_OPTION strength 3 _"Strength III: +1 damage to all attacks" "attacks/warblade-red.png" (
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"+1 damage"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever#turn end
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=1
                [/effect]
            [/object]
        )}
    )}
    {RAGE_UPGRADE_OPTION strength 4 _"Strength IV: +1 damage to all attacks" "attacks/warblade-red.png" (
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"+1 damage"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever#turn end
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=1
                [/effect]
            [/object]
        )}
    )}

    {RAGE_UPGRADE_OPTION strength 5 _"Strength V: Choose between +1 melee strikes and +1 ranged strikes" "attacks/warblade-red.png" (
        [message]
            speaker=narrator
            message=_"Choose your upgrade:"
            [option]
                image="attacks/warblade-red.png"
                message=_"+1 melee strikes"
                [command]
                    {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
                        [unstore_unit]
                            variable=this_item
                            find_vacant=no
                            text=_"+1 strikes"
                            red,green,blue=255,155,0
                        [/unstore_unit]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=$this_item.id
                            [/filter]
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_attacks=1
                            [/effect]
                        [/object]
                    )}
                [/command]
            [/option]
            [option]
                image="attacks/fire-breath-drake.png"
                message=_"+1 ranged strikes"
                [command]
                    {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
                        [unstore_unit]
                            variable=this_item
                            find_vacant=no
                            text=_"+1 strikes"
                            red,green,blue=255,155,0
                        [/unstore_unit]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=$this_item.id
                            [/filter]
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_attacks=1
                            [/effect]
                        [/object]
                    )}
                [/command]
            [/option]
        [/message]
    )}

    {RAGE_UPGRADE_OPTION strength 6 _"Strength VI: units become fearless" "attacks/warblade-red.png" (
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"fearless"
                red,green,blue=255,155,0
            [/unstore_unit]
            [modify_unit]
                [filter]
                    id=$this_item.id
                    [not]
                        trait=fearless
                    [/not]
                [/filter]
                {TRAIT_FEARLESS}
            [/modify_unit]
        )}
    )}

    {RAGE_UPGRADE_OPTION dexterity 1 _"Dexterity I: can immediately attack again after killing an enemy" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_unlocked yes}
    )}

    {RAGE_UPGRADE_OPTION dexterity 2 _"Dexterity II: can move 1 tile after killing an enemy" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_moves 1}
    )}

    {RAGE_UPGRADE_OPTION dexterity 3 _"Dexterity III: can move 2 tiles after killing an enemy" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_moves 2}
    )}

    {RAGE_UPGRADE_OPTION dexterity 4 _"Dexterity IV: can move 3 tiles after killing an enemy" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_moves 3}
    )}

    {RAGE_UPGRADE_OPTION dexterity 5 _"Dexterity V: can move 4 tiles after killing an enemy" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_moves 4}
    )}

    {RAGE_UPGRADE_OPTION dexterity 6 _"Dexterity VI: +1 moves, gain skirmisher after killing an enemy, until the start of your next turn" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_skirmisher yes}
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"+1 moves"
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=movement
                    increase=1
                [/effect]
            [/object]
        )}
    )}

    {RAGE_UPGRADE_OPTION dexterity 7 _"Dexterity VII: gain 10% defense after killing an enemy, until the start of your next turn" "attacks/tail-dragon.png" (
        {VARIABLE rage_fury_defense yes}
    )}

    {RAGE_UPGRADE_OPTION endurance 1 _"Endurance I: +3 max hp, recover 1 hp every turn (stacks with normal healing)" "attacks/ram.png" (
        {VARIABLE_OP rage_regen add 1}
        {RAGE_ENDURANCE_3HP}
    )}

    {RAGE_UPGRADE_OPTION endurance 2 _"Endurance II: +3 max hp, recover 2 hp every turn (stacks with normal healing)" "attacks/ram.png" (
        {VARIABLE_OP rage_regen add 1}
        {RAGE_ENDURANCE_3HP}
    )}

    {RAGE_UPGRADE_OPTION endurance 3 _"Endurance III: +3 max hp, recover 3 hp every turn (stacks with normal healing)" "attacks/ram.png" (
        {VARIABLE_OP rage_regen add 1}
        {RAGE_ENDURANCE_3HP}
    )}

    {RAGE_UPGRADE_OPTION endurance 4 _"Endurance IV: +3 max hp, recover 4 hp every turn (stacks with normal healing)" "attacks/ram.png" (
        {VARIABLE_OP rage_regen add 1}
        {RAGE_ENDURANCE_3HP}
    )}

    {RAGE_UPGRADE_OPTION endurance 5 _"Endurance V: When killing an enemy, recover hp equal to 20% of the enemy's max hp. +3 hp max hp" "attacks/ram.png" (
        {VARIABLE rage_devour yes}
        {RAGE_ENDURANCE_3HP}
    )}

    {RAGE_UPGRADE_OPTION endurance 6 _"Endurance VI: feeding ability. +3 hp max hp" "attacks/ram.png" (
        {VARIABLE rage_devour yes}
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"feeding"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_FEEDING}
                    [/abilities]
                [/effect]   
            [/object]
        )}
    )}

    {RAGE_UPGRADE_OPTION endurance 1 _"Endurance VII: Gain 5% to all resistance for every adjacent enemy. +3 hp max hp" "attacks/ram.png" (
        {RAGE_ENDURANCE_3HP}
        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
            [unstore_unit]
                variable=this_item
                find_vacant=no
                text=_"endurance"
                red,green,blue=255,155,0
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_ENDURANCE_VII}
                    [/abilities]
                [/effect]   
            [/object]
        )}
    )}
#enddef


#define RAGE_ADD_ONE_KILLED DUNEFOLK
    {VARIABLE_OP dunefolk_killed add 1}
    {VARIABLE dunefolk_modulo $dunefolk_killed}
    [print]
        duration=2000
        text=_"Dunefolk killed: $dunefolk_killed"
        color=255,155,0
        size=24
    [/print]
    {VARIABLE_OP dunefolk_modulo modulo 5}

    {IF_VAR dunefolk_modulo equals 0 (
    [then]

        #give a temporary buff for every 5 dunefolk killed
        [fire_event]
            name=upgrade
        [/fire_event]

#        {RAGE_APPLY_EFFECT_TO_ALL_DRAKES (
#            [unstore_unit]
#                variable=this_item
#                find_vacant=no
#                text=_"+1 damage"
#                red,green,blue=255,155,0
#            [/unstore_unit]
#            [object]
#                silent=yes
#                duration=forever#turn end
#    
#                [filter]
#                    id=$this_item.id
#                [/filter]
#
#                [effect]
#                    apply_to=hitpoints
#                    increase=2
#                    increase_total=2
#                [/effect]        
#
#                [effect]
#                    apply_to=attack
#                    increase_damage=1
#                [/effect]
#            [/object]
#        )}

    [/then]
    )}
#enddef

#define RAGE_BUFF_EVENTS
#this is so I can easily add upgrades from debug via :fire upgrade
[event]
    name=upgrade
    first_time_only=no

    [sound]
        name={SOUND_LIST:DRAKE_HIT}
    [/sound]

    {VARIABLE rage_upgrade_chosen no}
    [while]
    {VARIABLE_CONDITIONAL rage_upgrade_chosen equals no}
    [do]
    [message]
        speaker=narrator
        message=_"Choose an upgrades"
        [option]
            image="attacks/curse.png"
            message=_"Preview Upgrades"
            [show_if]
                {VARIABLE_CONDITIONAL rage_upgrade_preview not_equals yes}
            [/show_if]
            [command]
                {VARIABLE rage_upgrade_preview yes}
            [/command]
        [/option]
        [option]
            image="attacks/blank-attack.png"
            message=_"Return to Upgrade Selection"
            [show_if]
                {VARIABLE_CONDITIONAL rage_upgrade_preview equals yes}
            [/show_if]
            [command]
                {VARIABLE rage_upgrade_preview no}
            [/command]
        [/option]
        {RAGE_UPGRADE_LISt}
    [/message]
    [/do]
    [/while]
[/event]
[event]
    name=die
    first_time_only=no
    [filter_second]
        side=1
#        race=drake
    [/filter_second]

    {IF_VAR rage_devour equals yes (
    [then]
    [heal_unit]
        [filter]
            find_in=second_unit
        [/filter]
        amount="$($unit.max_hitpoints * 0.2)"
        animate=yes
        restore_statuses=no
    [/heal_unit]
    [/then]
    )}

    {IF_VAR rage_fury_unlocked equals yes (
    [then]

    {VARIABLE_OP second_unit.attacks_left add 1}
    {VARIABLE_OP second_unit.moves add $rage_fury_moves}
    [unstore_unit]
        variable=second_unit
        red,green,blue=255,155,0
        text= _ "FURY!"
        find_vacant=no
    [/unstore_unit]

    {IF_VAR rage_fury_skirmisher equals yes (
    [then]
    [object]
        silent=yes
        duration=turn
        [filter]
            find_in=second_unit
        [/filter]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_SKIRMISHER}
            [/abilities]
        [/effect]   
    [/object]
    [/then]
    )}

    {IF_VAR rage_fury_defense equals yes (
    [then]
    [object]
        silent=yes
        duration=turn
        [filter]
            find_in=second_unit
        [/filter]
        [effect]
            apply_to=defense
            replace=no
            [defense]
                deep_water=-10
                shallow_water=-10
                swamp_water=-10
                reef=-10
                flat=-10
                sand=-10
                forest=-10
                hills=-10
                mountains=-10
                village=-10
                castle=-10
                cave=-10
                frozen=-10
                unwalkable=-10
                fungus=-10
            [/defense]
        [/effect]    
    [/object]
    [/then]
    )}

    [/then]
    )}
[/event]
[event]
    name=die
    first_time_only=no
    [filter]
        race=dunefolk
        [filter_side]
            [enemy_of]
                side=1
            [/enemy_of]
        [/filter_side]
    [/filter]
    [filter_second]
        side=1
#        race=drake
    [/filter_second]
    {RAGE_ADD_ONE_KILLED DUNEFOLK}
[/event]
[event]
name=attacker hits
id=rage_blood1
first_time_only=no
[filter_second]
[not]
    [filter_wml]
        [status]
            not_living="yes"
        [/status]
    [/filter_wml]
[/not]
[/filter_second]

{VARIABLE_OP bleedchance rand 0,0,1}

{IF_VAR bleedchance equals 1 (
[then]

{VARIABLE_OP blood_imagemod rand "","~FL(horiz)"}
{RANDOM 1..5}
{PLACE_IMAGE "scenery/blood-$random|.png$blood_imagemod" $x1 $y1}

[/then]
)}

[/event] 
[event]
name=defender hits
id=rage_blood2
first_time_only=no
[filter]
[not]
    [filter_wml]
        [status]
            not_living="yes"
        [/status]
    [/filter_wml]
[/not]
[/filter]


{VARIABLE_OP bleedchance rand 0,0,1}

{IF_VAR bleedchance equals 1 (
[then]

{VARIABLE_OP blood_imagemod rand "~SCALE(60,60)","~SCALE(60,60)~FL(horiz)"}
{RANDOM 1..5}
{PLACE_IMAGE "scenery/blood-$random|.png$blood_imagemod" $x1 $y1}

[/then]
)}

[/event]

[event]
name=die
id=rage_blood3
first_time_only=no

[filter]
[not]
    [filter_wml]
        [status]
            not_living="yes"
        [/status]
    [/filter_wml]
[/not]
[/filter]

{VARIABLE_OP blood_imagemod rand "","~FL(horiz)"}

{RANDOM 1..5}
{PLACE_IMAGE "scenery/blood-$random|.png$blood_imagemod" $x1 $y1}

[/event]

[event]
    name=side 1 turn refresh
    first_time_only=no
    [heal_unit]
        [filter]
            side=1
        [/filter]
        amount=$rage_regen
        animate=yes
        restore_statuses=no
    [/heal_unit]
[/event]

#enddef

#can cover more than one village

#define RAGE_DESTRUCTIBLE_VILLAGE_EVENT FILTER_LOC EXTRA_CODE
[event]
    name=moveto
    first_time_only=no
    [filter]
        side=1
        [filter_location]
                terrain=*^V*
                [and]
                    {FILTER_LOC}
                [/and]
        [/filter_location]
    [/filter]

    [if]
    [have_unit]
        x,y=$x1,$y1
        [has_attack]
            type=fire
        [/has_attack]
    [/have_unit]
    [then]

    [animate_unit]
        flag=attack
        [filter]
            x,y=$x1,$y1
        [/filter]
        [primary_attack]
            type=fire
        [/primary_attack]
        hits=yes
    [/animate_unit]
    [sound]
        name=fire.wav
    [/sound]
    [delay]
        time=120
    [/delay]
    [sound]
        name=fire.wav
    [/sound]
    [delay]
        time=220
    [/delay]
    [sound]
        name=wose-die.ogg
    [/sound]
    [delay]
        time=180
    [/delay]
    [sound]
        name=torch-miss.ogg
    [/sound]
    [terrain]
    terrain=Rd#^Ecf
    x,y=$x1,$y1
    [/terrain] 
    [item]
        x=$x1
        y=$y1
        name=rage_flames
        halo=scenery/flames[01~15].png:50
    [/item]
    [delay]
        time=150
    [/delay]
    [/then]
    [else]

    [animate_unit]
        flag=attack
        [filter]
            x,y=$x1,$y1
            [not]
            [has_attack]
                type=fire
            [/has_attack]
            [/not]
        [/filter]
        [primary_attack]
            range=melee
        [/primary_attack]
        hits=yes
    [/animate_unit]

    [terrain]
    terrain=Rd#^Ecf
    x,y=$x1,$y1
    [/terrain]
    [/else]
    [/if]

#    {RANDOM 1..4}
#    [item]
#        x=$x1
#        y=$y1
#        name=rage_burnedvillage
#        image=scenery/village-human-burned$random|.png
#    [/item]

#    [sound_source]
#        id=rage_flames$x1|_$y1|
#        sounds=ambient/campfire.ogg
#        delay=9000
#        chance=100
#        check_fogged=no
#        check_shrouded=yes
#        x,y=$x1,$y1
#        full_range=5
#        fade_range=3
#        loop=-1
#    [/sound_source]
    [sound]
        name=scream.ogg
    [/sound]
    [delay]
        time=150
    [/delay]
    {RAGE_ADD_ONE_KILLED DUNEFOLK}
#    #to compensate for the fact that drakes can't use dunefolk villages to heal normally:
#    [heal_unit]
#        [filter]
#            x,y=$x1,$y1
#        [/filter]
#        amount=16
#        animate=yes
#        restore_statuses=no
#    [/heal_unit]
    {EXTRA_CODE}
[/event]
[event]
    name=start
    first_time_only=no
    [set_menu_item]
        id=rage_upgrade_preview
        description=_"View Upgrades"
        image="items/book2.png~CROP(21,23,27,24)~SCALE(20,20)"
        [show_if]
        [/show_if]
        [filter_location]
            [filter]
                side=1
            [/filter]
        [/filter_location]
        [command]
        {VARIABLE rage_upgrade_preview yes}
        [message]
            speaker=narrator
            message=_"Upgrade preview"
            {RAGE_UPGRADE_LISt}
        [/message]
        {VARIABLE rage_upgrade_preview no}
        [/command]
    [/set_menu_item]
[/event]
#enddef